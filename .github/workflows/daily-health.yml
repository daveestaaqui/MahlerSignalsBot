name: Daily Health Check
on:
  schedule:
    - cron: "10 14 * * *"
  workflow_dispatch:

jobs:
  health:
    runs-on: ubuntu-latest
    env:
      BASE: https://aurora-signals.onrender.com
      ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
    steps:
      - name: GET endpoints
        run: |
          set -euo pipefail
          curl -sS -o /dev/null -w "status  -> %{http_code}\n"  "$BASE/status"
          curl -sS -o /dev/null -w "healthz -> %{http_code}\n" "$BASE/healthz"
      - name: Admin POSTs
        run: |
          set -euo pipefail
          post() {
            ep="$1"; body="${2:-}"
            if [ -z "$body" ]; then
              code="$(curl -sS -o .out -w "%{http_code}" -X POST -H "Authorization: Bearer $ADMIN_TOKEN" "$BASE/$ep" || true)"
            else
              code="$(curl -sS -o .out -w "%{http_code}" -X POST -H "Authorization: Bearer $ADMIN_TOKEN" -H "Content-Type: application/json" --data-raw "$body" "$BASE/$ep" || true)"
            fi
            echo "$ep -> $code"
            if [ "$code" != "204" ] && [ "$code" != "200" ]; then
              echo "---- body ----"; head -c 400 .out || true; echo; exit 1
            fi
          }
          post admin/post-now
          post admin/test-telegram
          post admin/test-discord
          post admin/post-daily  '{"dryRun":false}'
          post admin/post-weekly '{"dryRun":false}'

          
    - name: GET /metrics
      run: |
        curl -sS -o /dev/null -w "metrics -> %{http_code}\n" "$BASE/metrics"
    - name: POST /admin/self-test
      run: |
        set -euo pipefail
        post() {
          ep="$1"; body="${2:-}"
          if [ -z "$body" ]; then
            code="$(curl -sS -o .out -w "%{http_code}" -X POST -H "Authorization: Bearer $ADMIN_TOKEN" "$BASE/$ep")"
          else
            code="$(curl -sS -o .out -w "%{http_code}" -X POST -H "Authorization: Bearer $ADMIN_TOKEN" -H "Content-Type: application/json" -d "$body" "$BASE/$ep")"
          fi
          echo "admin/self-test -> $code"
          if [ "$code" != "200" ]; then
            echo "---- body ----"; head -c 400 .out || true; echo; exit 1
          fi
        }
        post admin/self-test "{}"
