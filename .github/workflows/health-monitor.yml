name: Health Monitor
on:
  schedule:
    # Daily at 00:00 UTC
    - cron: '0 0 * * *'
    # Weekly on Monday at 14:00 UTC
    - cron: '0 14 * * 1'
  workflow_dispatch:

jobs:
  run-health-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Daily Health Check
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/daily-health.yml/dispatches \
            -d '{"ref":"main"}'

      - name: Trigger Weekly Health Check
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/weekly-health.yml/dispatches \
            -d '{"ref":"main"}'

      - name: Sleep to allow workflows to initialize
        run: sleep 30

      - name: Fetch and post status to Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.ALERT_DISCORD_WEBHOOK }}
        run: |
          # Get latest runs
          DAILY_RUNS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" 'https://api.github.com/repos/${{ github.repository }}/actions/runs?workflow_id=daily-health.yml&per_page=1')
          WEEKLY_RUNS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" 'https://api.github.com/repos/${{ github.repository }}/actions/runs?workflow_id=weekly-health.yml&per_page=1')
          
          DAILY_ID=$(echo "$DAILY_RUNS" | jq -r '.workflow_runs[0].id')
          DAILY_CONCLUSION=$(echo "$DAILY_RUNS" | jq -r '.workflow_runs[0].conclusion // "in_progress"')
          DAILY_URL="https://github.com/${{ github.repository }}/actions/runs/$DAILY_ID"
          
          WEEKLY_ID=$(echo "$WEEKLY_RUNS" | jq -r '.workflow_runs[0].id')
          WEEKLY_CONCLUSION=$(echo "$WEEKLY_RUNS" | jq -r '.workflow_runs[0].conclusion // "in_progress"')
          WEEKLY_URL="https://github.com/${{ github.repository }}/actions/runs/$WEEKLY_ID"
          
          # Determine status emojis
          DAILY_EMOJI="✅"
          if [[ "$DAILY_CONCLUSION" == "failure" ]]; then DAILY_EMOJI="❌"; fi
          if [[ "$DAILY_CONCLUSION" == "in_progress" ]]; then DAILY_EMOJI="⏳"; fi
          
          WEEKLY_EMOJI="✅"
          if [[ "$WEEKLY_CONCLUSION" == "failure" ]]; then WEEKLY_EMOJI="❌"; fi
          if [[ "$WEEKLY_CONCLUSION" == "in_progress" ]]; then WEEKLY_EMOJI="⏳"; fi
          
          # Determine color
          if [[ "$DAILY_CONCLUSION" == "success" && "$WEEKLY_CONCLUSION" == "success" ]]; then
            COLOR=65280
          elif [[ "$DAILY_CONCLUSION" == "in_progress" || "$WEEKLY_CONCLUSION" == "in_progress" ]]; then
            COLOR=16776960
          else
            COLOR=16711680
          fi
          
          TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          # Build JSON using jq
          PAYLOAD=$(jq -n \
            --arg title "Health Monitor Status" \
            --arg daily_emoji "$DAILY_EMOJI" \
            --arg daily_status "$DAILY_CONCLUSION" \
            --arg daily_url "$DAILY_URL" \
            --arg weekly_emoji "$WEEKLY_EMOJI" \
            --arg weekly_status "$WEEKLY_CONCLUSION" \
            --arg weekly_url "$WEEKLY_URL" \
            --arg timestamp "$TIMESTAMP" \
            --arg color "$COLOR" \
            '{embeds: [{title: $title, color: ($color | tonumber), fields: [{name: ("Daily Health Check " + $daily_emoji), value: ("Status: " + $daily_status + "\\n[View Run](" + $daily_url + ")"), inline: false}, {name: ("Weekly Health Check " + $weekly_emoji), value: ("Status: " + $weekly_status + "\\n[View Run](" + $weekly_url + ")"), inline: false}], timestamp: $timestamp}]}')
          
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -X POST "$DISCORD_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD"
            echo "Discord notification sent"
          else
            echo "Warning: ALERT_DISCORD_WEBHOOK secret not configured"
          fi
