name: Daily ManySignals marketing

on:
  schedule:
    - cron: "0 21 * * 1-5" # Weekday evening UTC; adjust as needed
  workflow_dispatch:

jobs:
  broadcast:
    runs-on: ubuntu-latest
    env:
      BASE_URL: https://aurora-signals.onrender.com
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID_FREE: ${{ secrets.TELEGRAM_CHAT_ID_FREE }}
      TELEGRAM_CHAT_ID_PRO: ${{ secrets.TELEGRAM_CHAT_ID_PRO }}
      TELEGRAM_CHAT_ID_ELITE: ${{ secrets.TELEGRAM_CHAT_ID_ELITE }}
      MARKETING_TELEGRAM_CHAT_ID: ${{ secrets.MARKETING_TELEGRAM_CHAT_ID }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      MARKETING_DISCORD_WEBHOOK_URL: ${{ secrets.MARKETING_DISCORD_WEBHOOK_URL }}
      X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
      MARKETING_DRY_RUN: ${{ secrets.MARKETING_DRY_RUN != '' && secrets.MARKETING_DRY_RUN || 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build TypeScript
        run: pnpm build
      - name: Dispatch daily marketing posts
        run: |
          pnpm tsx -e "
            import { sendMarketingPosts } from './src/services/marketing';
            const date = new Date();
            const dryRun = (process.env.MARKETING_DRY_RUN || 'true').toLowerCase() === 'true';
            sendMarketingPosts(date, { template: 'daily', dryRun }).then((result) => {
              console.log('marketing-daily complete', { dryRun: result.dryRun, signals: result.signals });
            }).catch((err) => {
              console.error('marketing-daily failed', err);
              process.exit(1);
            });
          "
