admin/post-now  admin/post-nowzname: Weekly Health Check

on:
  schedule:
    - cron: "0 14 * * 1"
  workflow_dispatch:

jobs:
  health:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      BASE: https://aurora-signals.onrender.com
      ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
    steps:
      - name: Check GET endpoints
        run: |
          set -euo pipefail
          curl -sS -o /dev/null -w "status  -> %{http_code}\n"  "$BASE/status"
          curl -sS -o /dev/null -w "healthz -> %{http_code}\n" "$BASE/healthz"

      - name: Check admin POST endpoints (Bearer; minimal bodies)
        run: |
          set -euo pipefail
          post_no_body () {
            ep="$1"
            code="$(curl -sS -o .out -w "%{http_code}" -X POST \
              -H "Authorization: Bearer $ADMIN_TOKEN" \
              "$BASE/$ep" || true)"
            echo "$ep -> $code"
            if [ "$code" != "204" ] && [ "$code" != "200" ]; then
              echo "---- body ----"; cat .out || true; echo "--------------"; exit 1
            fi
          }
          post_json () {
            ep="$1"; data="$2"
            code="$(curl -sS -o .out -w "%{http_code}" -X POST \
              -H "Authorization: Bearer $ADMIN_TOKEN" \
              -H "Content-Type: application/json; charset=utf-8" \
              --data-raw "$data" "$BASE/$ep" || true)"
            echo "$ep -> $code"
            if [ "$code" != "204" ] && [ "$code" != "200" ]; then
              echo "---- body ----"; cat .out || true; echo "--------------"; exit 1
            fi
          }
          # No body:
          post_no_body "admin/post-nowz"
          post_no_body "admin/test-telegram"
          post_no_body "admin/test-discord"
          # JSON body:
          post_json "admin/post-daily"  '{"dryRun":false}'
          post_json "admin/post-weekly" '{"dryRun":false}'
