name: AURORA Health Monitor

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  self-heal:
    runs-on: ubuntu-latest
    env:
      BASE_URL: ${{ secrets.BASE_URL || 'https://api.manysignals.finance' }}
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}
    steps:
      - name: Check health and self-heal
        run: |
          set -euo pipefail

          check() {
            phase="$1"
            status_code=$(curl -s -o /dev/null -w '%{http_code}' "${BASE_URL}/status")
            health_code=$(curl -s -o /dev/null -w '%{http_code}' "${BASE_URL}/healthz")
            echo "[${phase}] /status -> ${status_code}, /healthz -> ${health_code}"
            if [ "${status_code}" = "200" ] && [ "${health_code}" = "200" ]; then
              return 0
            fi
            return 1
          }

          trigger_redeploy() {
            if [ -z "${RENDER_API_KEY}" ] || [ -z "${RENDER_SERVICE_ID}" ]; then
              echo "Render credentials missing; cannot self-heal" >&2
              return 1
            fi
            curl -fsS -X POST \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache":true}' \
              "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" >/dev/null
          }

          send_alert() {
            status="$1"
            message="$2"
            if [ -z "${ALERT_WEBHOOK_URL}" ]; then
              echo "Alert webhook not configured"
              return 0
            fi
            jq -n --arg status "$status" --arg message "$message" '{status:$status, message:$message}' \
              | curl -fsS -H "Content-Type: application/json" -d @- "${ALERT_WEBHOOK_URL}" >/dev/null
          }

          if check "initial"; then
            echo "Service healthy."
            exit 0
          fi

          echo "Health check failed. Requesting redeploy via Render API…"
          if ! trigger_redeploy; then
            echo "Unable to trigger redeploy automatically" >&2
            send_alert "redeploy_failed" "ManySignals redeploy not attempted due to missing credentials at $(date --iso-8601=seconds)" || true
            exit 1
          fi

          echo "Redeploy triggered. Waiting for new instance…"
          sleep 60

          if check "post-redeploy"; then
            echo "✅ Self-healed after redeploy."
            send_alert "self-healed" "ManySignals self-healed after Render redeploy at $(date --iso-8601=seconds)" || true
            exit 0
          fi

          echo "Redeploy did not restore service." >&2
          send_alert "still-failing" "ManySignals redeploy failed to restore health at $(date --iso-8601=seconds)" || true
          exit 1
